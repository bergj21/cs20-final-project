<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="keywords" content="fitness, meal prep, healthy, groceries, food, activity, lifestyle">
    <title>Recipes</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="header.js"></script>
    <script src="apiHandler.js"></script>
    <style>
        .form-results-wrapper {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 40px;
            margin: 40px auto;
            padding: 0 20px;
            flex-wrap: wrap;
        }

        .results-panel {
            flex: 1 1 500px;
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 80vh;
        }

        .results-panel h2 {
            border-bottom: 2px solid var(--green-color);
        }

        .instructions {
            width: 80%;
            margin: 0 auto;
            color: var(--charcoal-color);
            text-align: center;
        }
        /* TODO: Must make this page more responsive */
    </style>
</head>
<body>
    <header>
        <a href="index.html">
            <img src="images/logo.jpg" alt="Logo" class="logo" />
        </a>
        <nav>
            <button class="menu-toggle">â˜°</button>
            <ul class="menu"></ul>
        </nav>
    </header>

    <main>
        <h1>Find a Recipe</h1>

        <div class="instructions">
            Get meals currated to your preferences today! Simply fill out the 
            form below and submit to filter through our wide selection of 
            recipes. You can even automatically populate the form by selecting 
            "Apply Your Preferences." 
        </div>

        <div class="form-results-wrapper">
            <div id="form-div"></div>
    
            <div class="results-panel">
                <h2>Results</h2>
                <div id="results"></div>
            </div>
        </div>
    </main>

    <script>
        // set up the page
        window.onload = function() {
            setHeader();
            
            getPreferencesForm("form-div", displayRecipes);

            // Wait a tick for the form to be inserted, then add custom elements
            setTimeout(() => {
                addUserPrefBtn();
            }, 0);
        }

        async function displayRecipes(preferences, meal) 
        {
            const resultsEl = document.getElementById('results');
            resultsEl.textContent = 'Loading...';

            const result = await recipeSearch(preferences, meal);

            // Clear the existing content
            resultsEl.innerHTML = '';

            if (result && result.results && result.results.length > 0) {
                // Show the number of results
                const resultCount = document.createElement('p');
                resultCount.textContent = `${result.totalResults} Recipes Found`;
                resultsEl.appendChild(resultCount);

                // Loop through each recipe and create a card
                for (const recipe of result.results) {
                    const recipeCard = await createRecipeCard(recipe, true);
                    resultsEl.appendChild(recipeCard);
                }
            } else {
                resultsEl.textContent = 'No recipes found.';
            }
        }

        function addUserPrefBtn()
        {
            const form = document.querySelector(".preferenceForm");
                if (!form) return;

                const userPrefBtn = document.createElement("button");
                userPrefBtn.type = "button";
                userPrefBtn.className = "submit-btn";
                userPrefBtn.style.marginLeft = "10px";
                userPrefBtn.textContent = "Apply Your Preferences";

                // Add it after the submit button
                const submitBtn = form.querySelector(".submit-btn");
                submitBtn.parentNode.appendChild(userPrefBtn);

                // Add click handler
                userPrefBtn.addEventListener("click", async () => {
                    const userId = localStorage.userId;
                    if (!userId) {
                        alert("User ID not found. Please log in.");
                        return;
                    }

                    try {
                        const response = await fetch(`/get-user-preferences?userId=${userId}`);
                        if (!response.ok) {
                            alert("Could not load preferences.");
                            return;
                        }

                        const prefs = await response.json();

                        // Populate the form fields
                        Object.entries(prefs).forEach(([key, value]) => {
                            const input = form.querySelector(`[name="${key}"]`);
                            if (input) input.value = value;
                        });
                    } catch (err) {
                        console.error("Failed to fetch user preferences:", err);
                        alert("Server error while loading preferences.");
                    }
                });
        }
    </script>

    <footer>
        <p>&copy; 2025 Meal Prep Buddy. All Rights Reserved.</p>
    </footer>
</body>
</html>
